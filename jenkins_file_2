pipeline {
    agent any

    tools {
        allure 'AllureCommandline'
        maven 'MAVEN_HOME'
    }

    stages {
        stage('Run Maven Based on Mode') {
            steps {
                script {
                    sh 'pwd && ls -l'

                    if (params.run_mode == 'testng') {
                        sh """
                            mvn clean test-compile exec:java \
                            -Dexec.args='${params.browser} ${params.env} ${params.component} ${params.test_type}' \
                            -Dheadless=${params.headless}
                        """
                    } else {
                        sh "mvn clean test-compile test -Dcucumber.filter.tags=@${params.cucumber_tags}"
                    }
                }
            }
        }

        stage('Allure Report') {
            steps {
                allure([
                    includeProperties: true,
                    jdk: '',
                    properties: [
                        [key: 'Run Mode', value: params.run_mode],
                        [key: 'Browser', value: params.browser],
                        [key: 'Env', value: params.env],
                        [key: 'Component', value: params.component]
                    ],
                    results: [[path: 'target/allure-results']]
                ])
            }
        }
    }
}
